# راهنمای تست‌های E2E با Playwright

## مشکل رایج: خطای EACCES

اگر با خطای زیر مواجه شدید:
```
connect EACCES ::1:xxxxx
```

این خطا به دلیل مشکلات اتصال شبکه در ویندوز رخ می‌دهد.

## راه‌حل‌ها

### راه‌حل 1: استفاده از سرور در حال اجرا (توصیه می‌شود)

1. ابتدا سرور را به صورت دستی اجرا کنید:
```bash
npm run dev
```

2. منتظر بمانید تا سرور کاملاً راه‌اندازی شود (معمولاً 10-30 ثانیه)

3. در یک ترمینال جدید، تست‌ها را اجرا کنید:
```bash
npm run e2e:smoke
```

### راه‌حل 2: پاک کردن پورت‌های قبلی

اگر پورت‌ها قبلاً در حال استفاده هستند:

```powershell
# پاک کردن پورت 5173
Get-Process -Id (Get-NetTCPConnection -LocalPort 5173).OwningProcess | Stop-Process -Force

# پاک کردن پورت 3001
Get-Process -Id (Get-NetTCPConnection -LocalPort 3001).OwningProcess | Stop-Process -Force
```

یا استفاده از اسکریپت آماده:
```bash
npm run dev:kill
```

### راه‌حل 3: غیرفعال کردن IPv6

اگر مشکل همچنان ادامه دارد، می‌توانید IPv6 را غیرفعال کنید:

1. باز کردن PowerShell به عنوان Administrator
2. اجرای دستور:
```powershell
Disable-NetAdapterBinding -Name "*" -ComponentID ms_tcpip6
```

3. راه‌اندازی مجدد سیستم

### راه‌حل 4: استفاده از 127.0.0.1 به جای localhost

فایل `playwright.config.ts` به‌روزرسانی شده است تا از `127.0.0.1` به جای `localhost` استفاده کند که مشکلات IPv6 را حل می‌کند.

## تنظیمات انجام شده

تنظیمات زیر برای بهبود پایداری اعمال شده است:

- ✅ استفاده از `127.0.0.1` به جای `localhost`
- ✅ افزایش timeout به 180 ثانیه
- ✅ فعال‌سازی `reuseExistingServer`
- ✅ استفاده از یک worker برای جلوگیری از تداخل
- ✅ افزودن retry برای تست‌های ناموفق
- ✅ تنظیمات بهینه برای Chrome

## اجرای تست‌ها

```bash
# اجرای تست‌های smoke
npm run e2e:smoke

# اجرای همه تست‌ها
npx playwright test

# اجرای تست‌ها در حالت UI
npx playwright test --ui

# نمایش گزارش
npx playwright show-report
```

## نکات مهم

1. **همیشه ابتدا سرور را اجرا کنید** و منتظر بمانید تا کاملاً آماده شود
2. **از یک ترمینال جدید** برای اجرای تست‌ها استفاده کنید
3. اگر خطا ادامه دارد، **سیستم را راه‌اندازی مجدد کنید**
4. در صورت نیاز، **فایروال یا آنتی‌ویروس** را موقتاً غیرفعال کنید

## پشتیبانی

اگر مشکل همچنان ادامه دارد، لطفاً موارد زیر را بررسی کنید:

- آیا Node.js نسخه 18 یا بالاتر نصب است؟
- آیا پورت‌های 5173 و 3001 آزاد هستند؟
- آیا فایروال یا آنتی‌ویروس اتصالات محلی را مسدود می‌کند؟
- آیا VPN یا Proxy فعال است؟

